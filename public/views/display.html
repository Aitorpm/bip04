<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Visualizar Video</title>
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="//code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
		<link rel="stylesheet" href="../stylesheets/chat.css">
		<script src="//code.jquery.com/jquery-1.8.2.min.js"></script>
		<script src="//code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
		<script src="/public/js/adapter.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBBboqOwLt3WKb7eod6a9MbVChHGF64Zs"></script>
	</head>

	<body>


		<div data-role="page" id="page1">
		    <div data-theme="a" data-role="header">
		        <a data-role="button" href="../index.html" class="ui-btn-left" data-ajax="false">
		            Home
		        </a>
		        <h3>
		            Visualizar Video
		        </h3>
		    </div>
			<table>
				<tr>
					<td>
						<div id="map" style="width:600px;height:600px;"></div>
					</td>

					<td>
						<img src="" id="frame" style="width:200px; height:200px"/>
						<div id="logger">ESTADO: </div>
						<br>
						<div>
							<div id="chatscroll" style="width: 600px; height: 300px; overflow-y: scroll; border: 1px solid grey; border-radius: 10px;" >
								<div  class="media msg" id="chat"></div>
							</div>

							<div>
								<table class="table">
									<thead>
									<tr>
										<td>Escribe un mensage:</td>
										<td><input class="form-control" id="text"></td>
										<td><button class="btn btn-primary" onclick="refresh()">Enviar</button></td>
									</tr>
									</tbody>
								</table>
							</div>
						</div>
					</td>
				</tr>
			</table>
		</div>



		<script type="text/javascript">
			var url = 'https://bip05.upc.es:5000';
			var msgs = [];
			var route = [];
			var markers = [];
			var img = document.getElementById("frame");
			var logger = document.getElementById('logger');
			var map = new google.maps.Map(document.getElementById("map"),
					{
						zoom: 17,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					});

			function refresh() {
				$('#chat').append("<div class='bubble you'>" +  $('#text').val() + "</div>"
				+ "<div style='clear:both;'></div>");

				$('#text').val('');

				var scroller = document.getElementById('chatscroll');
				scroller.scrollTop=scroller.scrollHeight;

			}

			$(document).keydown(function(e) {
				var keyCode = e.keyCode;
				var msg;

				if(keyCode == 37) msg = "Ir a la izquierda";
				if(keyCode == 38) msg = "Seguir recto";
				if(keyCode == 39) msg = "Ir a la derecha";
				if(keyCode == 40) msg = "Dar media vuelta ";
				if(keyCode == 32) msg = "Parar!";

				if(typeof msg!='undefined') {
					$('#chat').append("<div class='bubble you'>" + msg + "</div><div style='clear:both;'></div>");
				}

				var scroller = document.getElementById('chatscroll');
				scroller.scrollTop=scroller.scrollHeight;

				$.ajax({
					type : "POST",
					url : url + "/chat/postdirection",
					contentType: "application/x-www-form-urlencoded; charset=UTF-8", // this is the default value, so it's optional
					data : {
						"message" : msg
					}
				});
			});



		    /* SOCKET.IO */

		    var socket = io.connect(url);

		    socket.on('connect', function () {
		    	log('connected');
		    });

		    socket.on('disconnect', function () {
		    	log('disconnected');
		    });

		    socket.on('data', function(data) {
		    	img.src = data;
		    });

			socket.on('coords',function (data) {
				console.log('coords');
				console.log(data);
				for (var i = 0; i < markers.length; i++ ) {
					markers[i].setMap(null);
				}
				markers.length = 0;
				route.push(new google.maps.LatLng(data.latitude,data.longitude));
				console.log(route);
				map.setCenter(new google.maps.LatLng(data.latitude,data.longitude));
				var path = new google.maps.Polyline(
						{
							path: route,
							strokeColor: "#FF0000",
							strokeOpacity: 0.7,
							strokeWeight: 3
						});
				path.setMap(map);
				var marker=new google.maps.Marker({
					position:new google.maps.LatLng(data.latitude,data.longitude),
				});
				markers.push(marker);
				marker.setMap(map);
			});

			socket.on('chat',function (data) {
				if(data !== "undefined") $('#chat').append("<div class='bubble me'>" + data + "</div><div style='clear:both;'></div>");
			});

		    /* END SOCKET.IO */

			function log(message) {
		       logger.innerHTML = logger.innerHTML + message + "<br/>";
		    }
			
		</script>	

	</body>
</html>