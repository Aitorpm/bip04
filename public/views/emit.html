<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Emitir Video</title>
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
		<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>	
        <script src="/socket.io/socket.io.js"></script>
	</head>

	<body>


		<div data-role="page" id="page1">
		    <div data-theme="a" data-role="header">
		        <a data-role="button" href="../index.html" class="ui-btn-left" data-ajax="false">
		            Home
		        </a>
		        <h3>
		            Emitir Video
		        </h3>
		    </div>
		    <div data-role="content">
				<video id = "video" autoplay="true" style="width: 680px; heigth: 320px;"></video>
				<div id = "logger"></div>
		    </div>
		</div>


		<script type="text/javascript">


		    //var video = document.getElementById('video');
		    var logger = document.getElementById('logger');
		    var canvas = document.createElement('canvas');
		    var context = canvas.getContext('2d');
		    context.width = 680;
		    context.height = 510;


			function log(message) {
		       logger.innerHTML = logger.innerHTML + message + "<br/>";
		    };

			//console.log(navigator.getUserMedia('video'));

			/*navigator.getUserMedia(function (err, stream) {
				// if the browser doesn't support user media
				// or the user says "no" the error gets passed
				// as the first argument.
				if (err) {
					log('Error broadcasting: ' + error.code );
					console.log('failed');
				} else {
					console.log('got a stream', stream);
					log('Broadcasting...');
					video.src = stream;
				}
			});*/


			/*navigator.getUserMedia(function(successCallback, errorCallback);

		        function successCallback( stream ) {

		        };

		        function errorCallback( error ) {

		        };*/

			navigator.getMedia = ( navigator.getUserMedia ||
			navigator.webkitGetUserMedia ||
			navigator.mozGetUserMedia ||
			navigator.msGetUserMedia);

			navigator.getMedia (

					// Restricciones (contraints) *Requerido
					{
						video: true,
						//audio: true
					},

					// Funcion de finalizacion (Succes-Callback) *Requerido
					function(localMediaStream) {
						var video = document.querySelector('video');
						video.src = window.URL.createObjectURL(localMediaStream);
					},

					// errorCallback *Opcional
					function(err) {
						console.log("Ocurri√≥ el siguiente error: " + err);
					}

			);


		    /* SOCKET.IO */

		    var socket = io.connect('http://192.168.0.108:5000');

			console.log("sockets")
		    socket.on('connect', function () {
				console.log("sockets2")
				log('connected');
		    });

		    socket.on('disconnect', function () {
		    	log('disconnected');
		    });

		    function emit(message) {
		    	socket.emit('data', message);
		    }

		    /* END SOCKET.IO */

		    function sendFrame(video, context) {
		        context.drawImage(video, 0, 5, 200, 200);
		        emit(canvas.toDataURL('image/webp'));
		    }

		    setInterval(function() { sendFrame(video, context); }, 100);

		</script>

	</body>

</html>