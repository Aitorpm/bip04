<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Emitir Video</title>
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
		<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>	
        <script src="/socket.io/socket.io.js"></script>
	</head>

	<body>


		<div data-role="page" id="page1">
		    <div data-theme="a" data-role="header">
		        <a data-role="button" href="../index.html" class="ui-btn-left" data-ajax="false">
		            Home
		        </a>
		        <h3>
		            Emitir Video
		        </h3>
		    </div>
			<div class="select">
				<label for="videoSource">Video source: </label><select id="videoSource"></select>
			</div>
		    <div data-role="content">
				<video id = "video" autoplay="true" style="width: 680px; heigth: 320px;"></video>
				<div id = "logger"></div>
		    </div>
		</div>


		<script type="text/javascript">


		    //var video = document.getElementById('video');
		    var logger = document.getElementById('logger');
		    var canvas = document.createElement('canvas');
		    var context = canvas.getContext('2d');
			var videoSelect = document.querySelector('select#videoSource');
			var videoSource = videoSelect.value;
		    context.width = 680;
		    context.height = 510;

			function gotSources(sourceInfos) {
				for (var i = 0; i !== sourceInfos.length; ++i) {
					var sourceInfo = sourceInfos[i];
					var option = document.createElement('option');
					option.value = sourceInfo.id;
					if (sourceInfo.kind === 'video') {
						option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1);
						videoSelect.appendChild(option);
					} else {
						console.log('Some other kind of source: ', sourceInfo);
					}
				}
			}

			if (typeof MediaStreamTrack === 'undefined' ||
					typeof MediaStreamTrack.getSources === 'undefined') {
				alert('This browser does not support MediaStreamTrack.\n\nTry Chrome.');
			} else {
				MediaStreamTrack.getSources(gotSources);
			}

			function log(message) {
		       logger.innerHTML = logger.innerHTML + message + "<br/>";
		    };

			MediaStreamTrack.getSources(gotSources);

			navigator.getMedia = ( navigator.getUserMedia ||
			navigator.webkitGetUserMedia ||
			navigator.mozGetUserMedia ||
			navigator.msGetUserMedia);


			function successCallback(stream) {
				var video = document.querySelector('video');
				video.src = window.URL.createObjectURL(stream);
			}

			function errorCallback(error) {
				console.log('navigator.getUserMedia error: ', error);
			}

			function start() {
				if (window.stream) {
					videoElement.src = null;
					window.stream.stop();
				}
				var videoSource = videoSelect.value;
				var constraints = {

					video: {
						optional: [{
							sourceId: videoSource
						}]
					}
				};
				navigator.getMedia(constraints, successCallback, errorCallback);
			}
			videoSelect.onchange = start;
			start();




		    /* SOCKET.IO */

		    var socket = io.connect('http://192.168.0.108:5000');

			console.log("sockets")
		    socket.on('connect', function () {
				console.log("sockets2")
				log('connected');
		    });

		    socket.on('disconnect', function () {
		    	log('disconnected');
		    });

		    function emit(message) {
		    	socket.emit('data', message);
		    }

		    /* END SOCKET.IO */

		    function sendFrame(video, context) {
		        context.drawImage(video, 0, 5, 200, 200);
		        emit(canvas.toDataURL('image/webp'));
		    }

		    setInterval(function() { sendFrame(video, context); }, 100);


		</script>

	</body>

</html>